% File: project_notebook.tex
% Description: TeX file to generate Project Notebook (template)
% Author: George Hadley
% Website: http://nbitwonder.com
% Notes:
% 1) This document is written using the LaTeX typesetting language. For more information on
%	LaTeX, consult http://en.wikibooks.org/wiki/LaTeX/
% 2) This document needs to be compiled using pdfLaTeX. It is not supported with pdfTeX
%	at the present time
% 3) This document utilizes the \nbwheader command created in doc_header.tex. By default,
%	this file is located at:
%	/path-to-documentation-templates/lbr/doc_header.tex
% 4) This document utilizes commands and environments created in projnb_lbr.tex. By default,
%	this file is located at:
%	/path-to-documentation-templates/lbr/projnb_lbr.tex
% Version: 0.1
% Last Modified: 1-04-2010
\documentclass[12pt,letterpaper,onecolumn]{article}
\usepackage{graphicx}
\usepackage{float}
\usepackage{subfig}
\usepackage{tikz}
\usepackage{fancyhdr}
%\usepackage{kpfonts}  %Uncomment if kpfonts is installed and you want to use a non-default font
\usepackage{verbatim}
\usepackage{fullpage}
\usepackage{hyperref}
\usepackage{parskip}

%Path to global documentation library functions
%Modify this to /path-to-documentation-templates/lbr
\newcommand{\globallbr}{../lbr}

%Page layout settings
\setlength{\voffset}{-10pt}
\setlength{\headsep}{20pt}
\setlength{\headheight}{15pt}
\setlength{\topmargin}{-20pt}

\begin{comment}
  Hyperref settings: settings for the hyperref hyperlink package.
  For a more detailed listing of available settings, consult 
  	http://en.wikibooks.org/wiki/LaTeX/Hyperlinks#Customization

  IMPORTANT: For your document, modify the pdftitle, pdfauthor, pdfsubject,
	and pdfkeywords options to tailor to your document
\end{comment}
\hypersetup{
	bookmarks=true, 					%Enable pdf bookmarks
	pdfborder={0,0,0},					%Disable borders around links
	pdftitle={Class-D Amp Design Notebook)},		%Name of PDF document
	pdfauthor={Ben Laskowski},				%Author of PDF document
	pdfsubject={Embedded Electronics},		%Subject of PDF document
	pdfkeywords={diy,electronics,nbitwonder},	%Keywords for PDF document
	colorlinks={true},					%Enable colored links
	linkcolor=red,						%Internal link color
	citecolor=green,						%Citation link color
	filecolor=blue,						%File link color
	urlcolor=blue						%URL link color
}
\input{\globallbr/doc_header.tex}
\input{\globallbr/aliases.tex}
\input{lbr/project_notebook_lbr.tex}

%Modify these to reflect your documentation
\newcommand{\documentationtype}{Project Notebook}
\newcommand{\projectname}{Class D Amplifier }
\newcommand{\projectversion}{1.0}

%Header/Footer Definitions
\pagestyle{fancy}
\lhead{ }
\chead{ }
\rhead{\projectname  v\projectversion  \documentationtype}
\lfoot{\href{http://nbitwonder.com}{http://nbitwonder.com} }
\cfoot{\thepage}
\rfoot{\copyright 2011 NBitWonder}

\begin{document}
\thispagestyle{plain}
% Insert title page or header here
\nbwheader{\documentationtype}{\projectname}{\projectversion}
% Insert optional project index here
% For long projects, it is recommended that project entries be indexed
%	by entry, week, month, or year (or a combination of the above)

% Project Notebook entries
% Project Notebook entries should be enclosed in boxes and contain a tagline
%	detailing the entry number, date, revision (project minor version), and 
%	a short, descriptive title
\begin{nbentry}{001}{1/27/2011}{1.00}{Defining requirements}
After the overwhelming success of the Class-D audio amplifier, it was decided to pursue an impoved, less experimental version.  Some ideas for the revised circuit include using entirely surface mount parts (reduced size and potentially increased performance), a higher supply voltage (increased power output), and an output inductor with a lower series resistance.

Other ideas brought forward for consideration are the use of a different class, such as Class G, Class H, Class I, or Class T.  These ideas were rejected due to potential copyright/patent issues and complexity.
\end{nbentry}

\begin{nbentry}{002}{1/29/2011}{1.00}{Initial BOM}
This post is duplicated from the NBitWonder Forums.

After some research, I've arrived at a partial bill of materials.

\begin{itemize}
\item MOSFETs - DMN4009
\item Gate driver - IRS2004
\item Comparator - LM311
\item Integrating error amp - TL082
\end{itemize}

The amplifier will, like the prototype, be a self-oscillating type. My hope is that with proper construction techniques, the operating frequency will be quite high, ideally upwards of 500kHz. To that end, the output filter has been designed as a second-order Butterworth filter with a cutoff of 50kHz when operated with an 8-ohm speaker, a common value for home use. An inductor has been identified with a very low series resistance, which should help efficiency improve over the prototype.

The MOSFETs selected for use this time are cheaper than the IRL520Ns used last time and have a much lower on-state resistance, which should lead to increased efficiency. The MOSFET gate driver is cheaper than the one used for the experiment, but supports a lower drive current and a lower maximum voltage -- but at the voltages slated for use in this project, this becomes a non-issue.

The input stages (TL082 and LM311) are slated to be unchanged from the previous iteration, since the parts are already low-cost and well-suited for the task at hand.

Expected power output, based on a +/-18V supply and an 8-ohm speaker, is 
\(
\frac{18^2}{ 8 \times 2} = 20W
\)
 RMS under ideal conditions. Peak power (ie, turning on one MOSFET or the other and allowing the output filter to reach steady state) is arrived at with
\(
\frac{V^2}{ R}
\)
; the extra factor of 2 converts peak power to RMS. To support this power output, the power supply should be capable of delivering
\(
\sqrt{\frac{20W}{8 \Omega}} = 1.58
\)
amps per channel.
\end{nbentry}

\begin{nbentry}{003}{1/30/2011}{1.00}{PCB Layout}
Today saw significant work on the PCB layout.
\end{nbentry}

\begin{nbentry}{004}{1/31/2011}{1.00}{More PCB Layout}
The PCB layout was finished today.  A secondary version was created that features RCA input jacks instead of the more compact and lower cost 3.5mm stereo minijack.
\end{nbentry}

\begin{nbentry}{005}{3/5/2011}{1.00}{Prototype tweaks}
While waiting for the PCBs to come in, I worked on the breadboarded prototype a little bit.  I discovered that by changing the resistor and capacitor in the integrating feedback loop to 1M and 0.001uF respectively, power output increased greatly before audible distortion set in.  Thankfully, implementing this on the PCB does not require any changes in the layout.
\end{nbentry}

\begin{nbentry}{006}{3/6/2011}{1.00}{Continued prototype work}
Today, I constructed a duplicate amplifier circuit on the breadboard to have stereo capability, making sure to incorporate the changes from yesterday.  Testing with my laptop as a signal source produced good results, though it seems that clipping sets in at a lower level now.  My theory as to the cause is that the power supply I am using for testing cannot supply enough current to run both stereo channels at a high volume simultaneously.

With the 'laptop test' complete, I moved the amp to the living room to try it with my TV.  Upon powering on the circuit, a loud 60Hz buzz permeated the room.  It was determined that the cause of the buzz was a ground loop -- the TV and amp were both grounded, and the signal cable between them also had a ground connection.  Removing the AC ground from the power supply used on the amplifier solved the problem by eliminating all directly-connected paths between the two circuit grounds.
\end{nbentry}

\begin{nbentry}{007}{3/10/2011}{1.00}{PCBs Arrive}
The PCBs arrived today!

Rather than dive right in with their assembly, though, I decided to spend some time focusing on the amplifier's packaging.  As this is an area I have yet to pay any real attention to on any of my projects, I thought it appropriate to make it a priority for this project.  A brief trip to Radio Shack left me with some 4-40 mounting hardware (nuts, bolts, and washers), a 3x5x7 inch plastic project enclosure, a panel-mount audio input jack, and spring-loaded speaker terminals.  A few hours spent with a Dremel tool left me with suitably sized holes in the enclosure.
\end{nbentry}

\begin{nbentry}{008}{3/11/2011}{1.00}{Power supply assembly}
Today saw much of the amplifier's power supply assembly.  The transformer was mounted in the case, along with the power switch, fuse, and line input cord.  The appropriate connections were soldered, and the supply was tested.  The 24V center-tapped transformer that was selected for this build produced a no-load voltage of 13.6VAC from the center tap to each end of the secondary winding.  As this voltage when recitifed and filtered will exceed the voltage limits of at least one of the analog components, it may be necessary to drop the voltage slightly with diodes or an add-on regulator if the voltage does not drop appreciably under load.

I also began assembling the main amplifier PCB, but was forced to an abrupt end when I discovered that I made a mistake in the parts order, procuring one too few comparator and the wrong value of output filter capacitors.  A parts order was placed with Newark for the missing components.
\end{nbentry}

\begin{nbentry}{009}{3/12/2011}{1.00}{More PCB assembly work}
The PCB was built up to the extent possible today.  Still not populated are the various input and output connections (as these are more easily done once mounted in the case), the power filtering capacitors (as they are large and would likely impede access to the smaller-footprinted components).

In light of the unexpectedly high transformer secondary voltage discovered yesterday, some work was done to identify a better way of powering the amplifier.  An inexpensive switchmode controller, the AP34063, was found to be a sub-one-dollar solution to the problem.  In a future revision of the amplifier, a single-ended supply of up to 40VDC (or 28VAC followed by a rectifier) will be applied to the amplifier PCB and sent directly to the output MOSFETs.  This input voltage will also pass through a low-current switchmode regulator centered on the aforementioned AP34063 which will generate a 12VDC control supply to operate the input stages and MOSFET gate driver IC.  This will allow for a greater supply voltage, boosting output power; additionally, the power supply requirements will be greatly relaxed.
\end{nbentry}

\begin{nbentry}{010}{3/13/2011}{1.00}{Single-supply amplifier}
An intial design was drawn up for the single-supply amplifier.  It is now included in the github repository for the project, though it is far from done.
\end{nbentry}

\begin{nbentry}{011}{3/14/2011}{1.00}{Single-supply amplifier progress}
Some work was done on component placement for the single-supply board layout.  Additionally, the MCP14628 was identified as a potential gate driver for the new amplifier version.  It is similar to the IRS2004 currently in use, but with much lower propagation times between a gate command on the input and an action on the output.  Its deadtime is variable and is automatically configured based on the caharacteristics of the attached MOSFETs, which is far ahead of the fixed 520ns deadtime on the IRS2004.  It has been added to the Eagle library.

The downside of using the MCP gate driver is the limit on its bootstrap voltage pin -- 35v.  This means that the supply to the amplifier cannot exceed 30VDC, limiting power output to approximately 15W.  If the output sound quality is better, though, this is probably an acceptable tradeoff to make.  Otherwise, a similar part from National Semiconductor exists -- the LM5104 -- but its cost is about double the MCP part at roughly 3 dollars.
\end{nbentry}

\begin{nbentry}{012}{3/16/2011}{1.00}{Single-supply amplifier progress}
More work was done with regard to component placement on the single-supply version of the amplifier tonight.  It is believed that component placement is now final, more or less.

Additionally, an experiment was conducted with bridging mode on the breadboard.  Recognizeable sound was emitted from the speaker, but it was highly distorted.  It is believe at this time that the output filter's capacitor was connected between the positive speaker lead and the then-irrelevant ground instead of across the speaker terminals.  Further tests will be conducted as time allows.

Another version of the single-supply layout is in progress, too.  This secondary version features bridged outputs for each channel, allowing a theoretical 56W output per channel with a single-ended 30V supply.  If further breadboard tests with bridging (and eventually, single-supply bridging) are successful, this PCB layout will be furthered.  For now, it will be set aside.
\end{nbentry}

\begin{nbentry}{013}{3/19/2011}{1.00}{Progress on amplifiers}
The missing parts for the dual-supply amplifier prototype arrived yesterday.  Unfortunately, I rushed through the order process last week and requested the DIP-8 version of the LM311 instead of the SOIC-8 version.  Another order was placed and should hopefully arrive shortly.  Once I finally have a part with the correct footprint, this amplifier should come together very quickly.  I was, however, able to solder down the new filter capacitors, so that is done.

I spent some more time working on the single-supply amplifier layout.  It is now complete -- at least as a first draft -- and has been placed in the git repository.
\end{nbentry}

\begin{nbentry}{014}{3/22/2011}{1.00}{Magic smoke}
The replacement comparators arrived today, and they were installed.  The board then had its final components added and peripheral connections to the case-mounted connectors completed.  A brief power-up test revealed that nothing major was wrong.  The MOSFET gate drivers were running quite warm, but they were within specs outlined in the datasheet.  The power supply was measured to be a bipolar 19VDC for 38VDC total across the entire board.  The expected value was more like 33V, but this was deemed to be within spec due to the lightly-loaded power transformer.

The amplifier was then connected to a signal source (my TV) and speakers for its first real test.  The amplifier performed flawlessly for several minutes, but then suddenly ceased to function and simultaneously sent a large amplitude 60Hz buzz to the speakers.  Subsequent disassembly revealed a "burnt component" smell and a MOSFET solder joint that appears to have been reflowed.

The hypothesized failure mode is that a brief power glitch on the AC mains (due to my refrigerator turning on at the exact moment of amplifier failure) temporarily boosted the amplifier supply voltage sufficiently to over-volt the gate of the MOSFET -- which has a maximum Vgs of 20V -- and permanently short it.  This would explain the 60Hz hum of the power supply being directly coupled to the speakers as the transformer struggles to boost the output voltage to its designed operating point.  At this time, it is believed that replacing the power transformer with a lower-voltage output model and replaing the damaged MOSFET will fix the problem with this particular amplifier build.

As time allows, development will continue on the single-supply version of the amp.  It is believed that by regulating a few crucial control voltages, disasters like tonight's can be avoided in the future.  Until the amplifier failed, its output sound quality was noticeably better than the breadboaded version of the amplifier, implying tha the basic is sound and need not be abandoned.
\end{nbentry}

\end{document}
